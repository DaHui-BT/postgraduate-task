import{P as Q,h as y,a as H,F as R}from"./PTInput-DSqSraG9.js";import{d as N,o as i,b as M,w,S as q,e as a,_ as V,r as C,c as n,t as r,F as S,f as I,g as D,h as W,D as Z,i as x,j as $,k as v,l as ee,u as se,n as te,m as L,p as le,q as ie}from"./index-BspVQ7e6.js";const ae={class:"image-block"},ne=["src"],oe=N({__name:"ImageBlock",props:["image_url"],emits:["close"],setup(m,{emit:g}){const p=m,e=g;function b(){e("close")}return(h,_)=>(i(),M(q,null,{default:w(()=>[a("div",ae,[a("div",{class:"close",onClick:b},"X"),a("img",{src:p.image_url,alt:""},null,8,ne)])]),_:1}))}}),ce=V(oe,[["__scopeId","data-v-26ccb747"]]),de={class:"pt-upload"},ue={class:"pt-upload-button",for:"upload"},re=["accept"],me={key:0,class:"pt-upload-file-container"},_e={key:1,class:"pt-upload-file-message"},fe=N({__name:"PTUpload",props:{multiple:{type:Boolean,default:!1},accept:{type:String,default:""},text:{type:String,default:"Upload"},message:{type:String,default:"each file size must under 5MB"}},emits:["on-change"],setup(m,{emit:g}){const p=g,e=C([]);function b(h){for(let _ of h)if(_.size>5*1024*1024*8){alert("file size over 5MB");return}e.push(...h),p("on-change",e)}return(h,_)=>(i(),n("div",de,[a("label",ue,r(m.text),1),a("input",{class:"pt-upload-file",id:"upload",type:"file",multiple:"",accept:m.accept,onChange:_[0]||(_[0]=o=>b(o.target.files))},null,40,re),e.length>0?(i(),n("ul",me,[(i(!0),n(S,null,I(e,o=>(i(),n("li",{class:"pt-upload-file-item",key:o},r(o.name),1))),128))])):(i(),n("p",_e,r(m.message),1))]))}}),pe=V(fe,[["__scopeId","data-v-9a4f7612"]]),ge=m=>(le("data-v-424cbade"),m=m(),ie(),m),he={class:"submission"},be=ge(()=>a("h1",null,"This is the submission page",-1)),ke={key:2,class:"submission-content"},ve={class:"submission-collapse-container"},ye={class:"submission-collapse-func"},$e={class:"submission-collapse-func-item"},we={class:"submission-collapse-func-item"},Ce={class:"submission-collapse-func-item"},Se={class:"submission-func"},Ie=["onClick"],Be={class:"submission-func-container"},De={key:0,class:"submission-file"},Me=["onClick"],Ne={class:"submission-date"},Ve={class:"submission-message"},Ee={key:0,class:"submission-line"},Fe={key:3,class:"empty"},Te=N({__name:"Submission",setup(m){var T,U;const g=D(!1),p=D(!1),e=(T=W())==null?void 0:T.proxy;if(e==null||e==null)throw Error("Server, please try later");const b=["submit","checked","awarded","failed"],h=["#895ef9fc","#41d6ba","#3ddf58","#f95e85fc"],_=D(null),o=new Z,f=C([]),k=C([]),u=C({user_id:(U=o.user)==null?void 0:U.id,file_id_list:[],file_name_list:[],date:new Date,title:"",message:"",status:0});async function E(){e==null||e.$loading.show(),await o.findList("postgraduate-task","submission").then(l=>{k.splice(0,k.length),f.splice(0,f.length),l!=null&&k.push(...l),k.sort((t,s)=>s.date.getTime()-t.date.getTime()),k.forEach(t=>{f.length==0||f.filter(s=>s.id==y(t.date).format("YY-MM-DD")).length==0?f.push({id:y(t.date).format("YY-MM-DD"),task_list:[t]}):f.map(s=>{if(s.id==y(t.date).format("YY-MM-DD")){s.task_list.push(t);return}})})}).catch(l=>{e==null||e.$notification.show("Error",l),console.log(l)}).finally(()=>{e==null||e.$loading.hide()})}x(async()=>{await E()});function A(l){l.target.parentNode.nextElementSibling.style.display=="none"?l.target.parentNode.nextElementSibling.style.display="block":l.target.parentNode.nextElementSibling.style.display="none"}function B(l,t){let s=0;for(let c of l)c.status>=t&&s++;return s}function X(l){e==null||e.$loading.show(),_.value=null,o.getImageUrl("postgraduate-task","files",l).then(t=>{_.value=t,e==null||e.$loading.hide(),g.value=!0})}function G(){_.value=null,g.value=!1}function F(){p.value=!p.value,p.value==!1&&(u.message==null||u.title==null||u.message.trim().length==0||u.title.trim().length==0?alert("Nothing to submit! The form should be completed!"):(u.date=new Date,o.addOne("postgraduate-task","submission",u).then(()=>{e==null||e.$notification.show("Success","add submission successfully!"),E()})))}async function J(l){if(confirm(`is ready to delete ${l.title}!`)){if(prompt("input your delete token")!="delete")return;e==null||e.$loading.show(),await o.findOne("postgraduate-task","submission",{_id:l._id}).then(c=>{c&&c.file_id_list&&c.file_id_list.length>0&&o.deleteMany("postgraduate-task","files",{_id:{$in:c.file_id_list}}),c&&o.deleteOne("postgraduate-task","submission",{_id:c._id})}).finally(()=>{e==null||e.$loading.hide()})}else e==null||e.$notification.show("Cancel","operate already canceled!")}function K(l){e==null||e.$loading.show();for(let t of l)o.uploadFile("postgraduate-task","files",t).then(s=>{var c,d;(c=u.file_id_list)==null||c.push(s.insertedId),(d=u.file_name_list)==null||d.push(s.file_name)}).catch(s=>{console.log(s),e==null||e.$notification("Error","upload file error, please try again later")}).finally(()=>{e==null||e.$loading.hide()})}return(l,t)=>(i(),n("div",he,[g.value?(i(),M(ce,{key:0,image_url:_.value,onClose:G},null,8,["image_url"])):$("",!0),be,v(Q,{class:"submit-button",type:"primary",onClick:F},{default:w(()=>[ee("submit")]),_:1}),p.value?(i(),M(q,{key:1},{default:w(()=>[v(R,{onClose:t[2]||(t[2]=()=>p.value=!1),onSubmit:F},{form:w(()=>[v(H,{placeholder:"title",modelValue:u.title,"onUpdate:modelValue":t[0]||(t[0]=s=>u.title=s)},null,8,["modelValue"]),v(pe,{onOnChange:K,accept:".png, .jpg, .jpeg"}),v(H,{placeholder:"message",modelValue:u.message,"onUpdate:modelValue":t[1]||(t[1]=s=>u.message=s)},null,8,["modelValue"])]),_:1})]),_:1})):$("",!0),(f==null?void 0:f.length)>0?(i(),n("ul",ke,[(i(!0),n(S,null,I(f,(s,c)=>(i(),n("li",{class:"submission-item",key:s.id},[a("div",ve,[a("div",{class:"submission-collapse",onClick:A},r(s.id),1),a("div",ye,[a("span",$e,"Submitted: "+r(B(s.task_list,0)),1),a("span",we,"Checked: "+r(B(s.task_list,1)),1),a("span",Ce,"Awarded: "+r(B(s.task_list,2)),1)])]),a("div",{class:"submission-item-container",style:L({display:c==0?"display":"none"})},[(i(!0),n(S,null,I(s.task_list,(d,Y)=>{var z,P;return i(),n("div",{class:"submission-item-container-content",key:Y},[a("div",Se,[a("div",{class:"submission-title",onClick:O=>J(d)},r(d.title),9,Ie),a("div",Be,[((z=d.file_id_list)==null?void 0:z.length)>0?(i(),n("div",De,[(i(!0),n(S,null,I(d.file_name_list,(O,j)=>(i(),n("div",{class:"submission-file-item",key:j,onClick:Ue=>X(d.file_id_list[j])},r(O),9,Me))),128))])):$("",!0),a("div",Ne,r(se(y)(d.date).format("HH:mm:ss")),1),a("div",{class:te({"submission-status":!0,"submission-status-error":d.status==3}),style:L({backgroundColor:h[d.status]})},r(b[d.status]),7)])]),a("div",Ve,r(d.message),1),Y!=((P=s.task_list)==null?void 0:P.length)-1?(i(),n("hr",Ee)):$("",!0)])}),128))],4)]))),128))])):(i(),n("div",Fe," Nothing to show! "))]))}}),Pe=V(Te,[["__scopeId","data-v-424cbade"]]);export{Pe as default};
