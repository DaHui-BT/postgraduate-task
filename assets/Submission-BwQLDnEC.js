import{P as A,h as V,a as R,F as te}from"./PTInput-S-xtJb3m.js";import{d as U,o as i,b as N,w as I,S as J,e as o,_ as Y,r as F,c as a,t as d,F as B,f as D,g as C,h as ie,D as le,i as ae,j as S,k as y,l as X,u as P,n as oe,m as G,p as ne,q as ce,s as ue}from"./index-Dgl24Zx3.js";const de={class:"image-block"},_e=["src"],fe=U({__name:"ImageBlock",props:["image_url"],emits:["close"],setup(_,{emit:b}){const g=_,e=b;function p(){e("close")}return(v,f)=>(i(),N(J,null,{default:I(()=>[o("div",de,[o("div",{class:"close",onClick:p},"X"),o("img",{src:g.image_url,alt:""},null,8,_e)])]),_:1}))}}),me=Y(fe,[["__scopeId","data-v-26ccb747"]]),re={class:"pt-upload"},he={class:"pt-upload-button",for:"upload"},ge=["accept"],pe={key:0,class:"pt-upload-file-container"},be={key:1,class:"pt-upload-file-message"},ve=U({__name:"PTUpload",props:{multiple:{type:Boolean,default:!1},accept:{type:String,default:""},text:{type:String,default:"Upload"},message:{type:String,default:"each file size must under 5MB"}},emits:["on-change"],setup(_,{emit:b}){const g=b,e=F([]);function p(v){for(let f of v)if(f.size>5*1024*1024*8){alert("file size over 5MB");return}e.push(...v),g("on-change",e)}return(v,f)=>(i(),a("div",re,[o("label",he,d(_.text),1),o("input",{class:"pt-upload-file",id:"upload",type:"file",multiple:"",accept:_.accept,onChange:f[0]||(f[0]=m=>p(m.target.files))},null,40,ge),e.length>0?(i(),a("ul",pe,[(i(!0),a(B,null,D(e,m=>(i(),a("li",{class:"pt-upload-file-item",key:m},d(m.name),1))),128))])):(i(),a("p",be,d(_.message),1))]))}}),ke=Y(ve,[["__scopeId","data-v-9a4f7612"]]),$e=_=>(ce("data-v-38c3104c"),_=_(),ue(),_),we={class:"submission"},Ce=$e(()=>o("h1",null,"This is the submission page",-1)),Se={key:2,class:"submission-content"},ye={class:"submission-collapse-container"},Ie=["onClick"],Be={class:"submission-collapse-func"},De={class:"submission-collapse-func-item"},Me={class:"submission-collapse-func-item"},Ve={class:"submission-collapse-func-item"},Ne={key:0,class:"submission-item-container"},Fe={class:"submission-func"},Te=["onClick"],Ee={class:"submission-func-container"},Pe={key:0,class:"submission-file"},Ue=["onClick"],Ye={class:"submission-date"},ze=["value","selected","onClick"],Oe={class:"submission-message"},je={key:0,class:"submission-line"},He={key:3,class:"empty"},Le=U({__name:"Submission",setup(_){var O,j;const b=C(!1),g=C(!1),e=(O=ie())==null?void 0:O.proxy;if(e==null||e==null)throw Error("Server, please try later");const p=["submit","checked","awarded","failed"],v=["#895ef9fc","#41d6ba","#3ddf58","#f95e85fc"],f=C(null);let m=C(!1),M=C(0);const r=new le,h=F([]),$=F([]),c=F({user_id:(j=r.user)==null?void 0:j.id,file_id_list:[],file_name_list:[],date:new Date,title:"",message:"",status:0});async function T(){e==null||e.$loading.show(),await r.findList("postgraduate-task","submission").then(l=>{$.splice(0,$.length),h.splice(0,h.length),l!=null&&$.push(...l),$.sort((t,s)=>s.date.getTime()-t.date.getTime()),$.forEach(t=>{h.length==0||h.filter(s=>s.id==V(t.date).format("YY-MM-DD")).length==0?h.push({id:V(t.date).format("YY-MM-DD"),task_list:[t]}):h.map(s=>{if(s.id==V(t.date).format("YY-MM-DD")){s.task_list.push(t);return}})})}).catch(l=>{e==null||e.$notification.show("Error",l),console.log(l)}).finally(()=>{e==null||e.$loading.hide()})}ae(async()=>{await T()});function K(l){M.value==l?M.value=-1:M.value=l,console.log(l)}function E(l,t){let s=0;for(let u of l)u.status>=t&&s++;return s}function Q(l){e==null||e.$loading.show(),f.value=null,r.getImageUrl("postgraduate-task","files",l).then(t=>{f.value=t,e==null||e.$loading.hide(),b.value=!0})}function W(){f.value=null,b.value=!1}function z(){g.value=!g.value,g.value==!1&&(c.message==null||c.title==null||c.message.trim().length==0||c.title.trim().length==0?alert("Nothing to submit! The form should be completed!"):(c.date=new Date,r.addOne("postgraduate-task","submission",c).then(()=>{e==null||e.$notification.show("Success","add submission successfully!"),T(),c.file_id_list=[],c.file_name_list=[],c.message="",c.title=""})))}async function Z(l){if(confirm(`is ready to delete ${l.title}!`)){if(prompt("input your delete token")!="delete")return;e==null||e.$loading.show(),await r.findOne("postgraduate-task","submission",{_id:l._id}).then(u=>{u&&u.file_id_list&&u.file_id_list.length>0&&r.deleteMany("postgraduate-task","files",{_id:{$in:u.file_id_list}}),u&&r.deleteOne("postgraduate-task","submission",{_id:u._id}),T()}).finally(()=>{e==null||e.$loading.hide()})}else e==null||e.$notification.show("Cancel","operate already canceled!")}function x(l){e==null||e.$loading.show();for(let t of l)r.uploadFile("postgraduate-task","files",t).then(s=>{var u,n;(u=c.file_id_list)==null||u.push(s.insertedId),(n=c.file_name_list)==null||n.push(s.file_name)}).catch(s=>{console.log(s),e==null||e.$notification("Error","upload file error, please try again later")}).finally(()=>{e==null||e.$loading.hide()})}function ee(l,t){var s;((s=r.user)==null?void 0:s.id)=="670a8dc865ba7090dcbfa4e3"&&t<p.length?confirm(`confirm to change status to ${p[t]}`)?(l.status=t,e==null||e.$loading.show(),r.updateOne("postgraduate-task","submission",{_id:l._id},{status:t}).then(()=>{e==null||e.$notification.show("Success","update status successfully")}).catch(u=>{e==null||e.$notification.show("Error",u.error)}).finally(()=>{e==null||e.$loading.hide()})):e==null||e.$notification.show("Cancel","cancel operate successfully"):e==null||e.$notification.show("No Permission","you have no permission!"),m.value=!1}return(l,t)=>(i(),a("div",we,[b.value?(i(),N(me,{key:0,image_url:f.value,onClose:W},null,8,["image_url"])):S("",!0),Ce,y(A,{class:"submit-button",type:"primary",onClick:z},{default:I(()=>[X("submit")]),_:1}),g.value?(i(),N(J,{key:1},{default:I(()=>[y(te,{onClose:t[2]||(t[2]=()=>g.value=!1),onSubmit:z},{form:I(()=>[y(R,{placeholder:"title",modelValue:c.title,"onUpdate:modelValue":t[0]||(t[0]=s=>c.title=s)},null,8,["modelValue"]),y(ke,{onOnChange:x,accept:".png, .jpg, .jpeg"}),y(R,{placeholder:"message",modelValue:c.message,"onUpdate:modelValue":t[1]||(t[1]=s=>c.message=s)},null,8,["modelValue"])]),_:1})]),_:1})):S("",!0),(h==null?void 0:h.length)>0?(i(),a("ul",Se,[(i(!0),a(B,null,D(h,(s,u)=>(i(),a("li",{class:"submission-item",key:s.id},[o("div",ye,[o("div",{class:"submission-collapse",onClick:n=>K(u)},d(s.id),9,Ie),o("div",Be,[o("span",De,"Submitted: "+d(E(s.task_list,0)),1),o("span",Me,"Checked: "+d(E(s.task_list,1)),1),o("span",Ve,"Awarded: "+d(E(s.task_list,2)),1)])]),P(M)==u?(i(),a("div",Ne,[(i(!0),a(B,null,D(s.task_list,(n,H)=>{var L,q;return i(),a("div",{class:"submission-item-container-content",key:H},[o("div",Fe,[o("div",{class:"submission-title",onClick:w=>Z(n)},d(n.title),9,Te),o("div",Ee,[((L=n.file_id_list)==null?void 0:L.length)>0?(i(),a("div",Pe,[(i(!0),a(B,null,D(n.file_name_list,(w,k)=>(i(),a("div",{class:"submission-file-item",key:k,onClick:se=>Q(n.file_id_list[k])},d(w),9,Ue))),128))])):S("",!0),o("div",Ye,d(P(V)(n.date).format("HH:mm:ss")),1),P(m)?(i(),a("select",{key:2,class:"submission-option",style:G({backgroundColor:v[n.status]})},[(i(),a(B,null,D(p,(w,k)=>o("option",{class:"submission-option-item",value:k,key:k,selected:n.status==k,onClick:se=>ee(n,k)},d(w),9,ze)),64))],4)):(i(),N(A,{key:1,class:oe({"submission-status":!0,"submission-status-error":n.status==3}),style:G({backgroundColor:v[n.status]}),onClick:t[3]||(t[3]=w=>ne(m)?m.value=!0:m=!0)},{default:I(()=>[X(d(p[n.status]),1)]),_:2},1032,["class","style"]))])]),o("div",Oe,d(n.message),1),H!=((q=s.task_list)==null?void 0:q.length)-1?(i(),a("hr",je)):S("",!0)])}),128))])):S("",!0)]))),128))])):(i(),a("div",He," Nothing to show! "))]))}}),Re=Y(Le,[["__scopeId","data-v-38c3104c"]]);export{Re as default};
