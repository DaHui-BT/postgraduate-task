import{d as q,o as l,k as F,w as B,S as W,b as o,_ as z,r as P,c as a,t as d,F as D,e as M,l as $,u as ae,g as oe,D as ne,m as ue,n as S,i as I,h as G,f as Y,q as ce,s as J,v as de,p as re,j as _e}from"./index-CoWUiQRq.js";import{P as K,h as N}from"./PTButton-BF17qq1j.js";import{P as Q,F as fe}from"./PTInput-BS8_lRov.js";const me={class:"image-block"},he=["src"],ge=q({__name:"ImageBlock",props:["image_url"],emits:["close"],setup(r,{emit:b}){const h=r,f=b;function e(){f("close")}return(g,v)=>(l(),F(W,null,{default:B(()=>[o("div",me,[o("div",{class:"close",onClick:e},"X"),o("img",{src:h.image_url,alt:""},null,8,he)])]),_:1}))}}),pe=z(ge,[["__scopeId","data-v-26ccb747"]]),ve={class:"pt-upload"},be={class:"pt-upload-button",for:"upload"},ke=["accept"],$e={key:0,class:"pt-upload-file-container"},we={key:1,class:"pt-upload-file-message"},Ce=q({__name:"PTUpload",props:{multiple:{type:Boolean,default:!1},accept:{type:String,default:""},text:{type:String,default:"Upload"},message:{type:String,default:"each file size must under 5MB"},uploaded_files:{type:Array,defalt:[]}},emits:["on-change"],setup(r,{emit:b}){const h=b,f=P([]);function e(g){for(let v of g)if(v.size>5*1024*1024*8){alert("file size over 5MB");return}f.splice(0,f.length),f.push(...g),h("on-change",f)}return(g,v)=>(l(),a("div",ve,[o("label",be,d(r.text),1),o("input",{class:"pt-upload-file",id:"upload",type:"file",multiple:"",accept:r.accept,onChange:v[0]||(v[0]=p=>e(p.target.files))},null,40,ke),r.uploaded_files.length>0?(l(),a("ul",$e,[(l(!0),a(D,null,M(r.uploaded_files,p=>(l(),a("li",{class:"pt-upload-file-item",key:p},d(p),1))),128))])):(l(),a("p",we,d(r.message),1))]))}}),ye=z(Ce,[["__scopeId","data-v-573e4621"]]),Se=r=>(re("data-v-32aa57a2"),r=r(),_e(),r),Ie={class:"submission"},Be=Se(()=>o("h1",null,"This is the submission page",-1)),De={key:2,class:"submission-content"},Me={class:"submission-collapse-container"},Ve=["onClick"],Ne={class:"submission-collapse-func"},Fe={class:"submission-collapse-func-item"},Pe={class:"submission-collapse-func-item"},Te={class:"submission-collapse-func-item"},Ee={key:0,class:"submission-item-container"},Ue={class:"submission-func"},Ye=["onClick"],qe={class:"submission-func-container"},ze={key:0,class:"submission-file"},Oe=["onClick"],Re={class:"submission-date"},je=["value","selected","onClick"],Ae={class:"submission-message"},He={key:0,class:"submission-line"},Le={key:3,class:"empty"},Xe=q({__name:"Submission",setup(r){var R,j,A;const b=$(!1),h=$(!1),f=ae(),e=(R=oe())==null?void 0:R.proxy;if(e==null||e==null)throw Error("Server, please try later");const g=["submit","checked","awarded","failed"],v=["#895ef9fc","#41d6ba","#3ddf58","#f95e85fc"],p=$(null);let w=$(!1),V=$(0);const _=new ne;let T=$((j=_.user)==null?void 0:j.id);const m=P([]),C=P([]),n=P({user_id:(A=_.user)==null?void 0:A.id,file_id_list:[],file_name_list:[],date:new Date,title:"",message:"",status:0});async function E(){e==null||e.$loading.show(),await _.findList("postgraduate-task","submission",{user_id:{$eq:T.value}}).then(i=>{C.splice(0,C.length),m.splice(0,m.length),i!=null&&C.push(...i),C.sort((t,s)=>s.date.getTime()-t.date.getTime()),C.forEach(t=>{m.length==0||m.filter(s=>s.id==N(t.date).format("YY-MM-DD")).length==0?m.push({id:N(t.date).format("YY-MM-DD"),task_list:[t]}):m.map(s=>{if(s.id==N(t.date).format("YY-MM-DD")){s.task_list.push(t);return}})})}).catch(i=>{e==null||e.$notification.show("Error",i),console.log(i)}).finally(()=>{e==null||e.$loading.hide()})}ue(async()=>{var i;console.log(f.currentRoute.value.query._id),f.currentRoute.value.query._id?T.value=f.currentRoute.value.query._id.toString():T.value=(i=_.user)==null?void 0:i.id,await E()});function Z(i){V.value==i?V.value=-1:V.value=i}function U(i,t){let s=0;for(let c of i)c.status>=t&&s++;return s}function x(i){e==null||e.$loading.show(),p.value=null,_.getImageUrl("postgraduate-task","files",i).then(t=>{p.value=t,e==null||e.$loading.hide(),b.value=!0})}function ee(){p.value=null,b.value=!1}function O(){h.value=!h.value,h.value==!1&&(n.message==null||n.title==null||n.message.trim().length==0||n.title.trim().length==0?alert("Nothing to submit! The form should be completed!"):(n.date=new Date,_.addOne("postgraduate-task","submission",n).then(()=>{e==null||e.$notification.show("Success","add submission successfully!"),E(),n.file_id_list=[],n.file_name_list=[],n.message="",n.title=""})))}async function se(i){if(confirm(`is ready to delete ${i.title}!`)){if(prompt("input your delete token")!="delete")return;e==null||e.$loading.show(),await _.findOne("postgraduate-task","submission",{_id:i._id}).then(c=>{c&&c.file_id_list&&c.file_id_list.length>0&&_.deleteMany("postgraduate-task","files",{_id:{$in:c.file_id_list}}),c&&_.deleteOne("postgraduate-task","submission",{_id:c._id}),E()}).finally(()=>{e==null||e.$loading.hide()})}else e==null||e.$notification.show("Cancel","operate already canceled!")}function te(i){e==null||e.$loading.show();for(let t of i)_.uploadFile("postgraduate-task","files",t).then(s=>{var c,u;(c=n.file_id_list)==null||c.push(s.insertedId),(u=n.file_name_list)==null||u.push(s.file_name)}).catch(s=>{console.log(s),e==null||e.$notification("Error","upload file error, please try again later")}).finally(()=>{e==null||e.$loading.hide()})}function ie(i,t){var s;((s=_.user)==null?void 0:s.id)=="670a8dc865ba7090dcbfa4e3"&&t<g.length?confirm(`confirm to change status to ${g[t]}`)?(i.status=t,e==null||e.$loading.show(),_.updateOne("postgraduate-task","submission",{_id:i._id},{status:t}).then(()=>{e==null||e.$notification.show("Success","update status successfully")}).catch(c=>{e==null||e.$notification.show("Error",c.error)}).finally(()=>{e==null||e.$loading.hide()})):e==null||e.$notification.show("Cancel","cancel operate successfully"):e==null||e.$notification.show("No Permission","you have no permission!"),w.value=!1}return(i,t)=>(l(),a("div",Ie,[b.value?(l(),F(pe,{key:0,image_url:p.value,onClose:ee},null,8,["image_url"])):S("",!0),Be,I(K,{class:"submit-button",type:"primary",onClick:O},{default:B(()=>[G("submit")]),_:1}),h.value?(l(),F(W,{key:1},{default:B(()=>[I(fe,{onClose:t[2]||(t[2]=()=>h.value=!1),onSubmit:O},{form:B(()=>[I(Q,{placeholder:"title",modelValue:n.title,"onUpdate:modelValue":t[0]||(t[0]=s=>n.title=s)},null,8,["modelValue"]),I(ye,{onOnChange:te,accept:".png, .jpg, .jpeg",uploaded_files:n.file_name_list},null,8,["uploaded_files"]),I(Q,{placeholder:"message",modelValue:n.message,"onUpdate:modelValue":t[1]||(t[1]=s=>n.message=s)},null,8,["modelValue"])]),_:1})]),_:1})):S("",!0),(m==null?void 0:m.length)>0?(l(),a("ul",De,[(l(!0),a(D,null,M(m,(s,c)=>(l(),a("li",{class:"submission-item",key:s.id},[o("div",Me,[o("div",{class:"submission-collapse",onClick:u=>Z(c)},d(s.id),9,Ve),o("div",Ne,[o("span",Fe,"Submitted: "+d(U(s.task_list,0)),1),o("span",Pe,"Checked: "+d(U(s.task_list,1)),1),o("span",Te,"Awarded: "+d(U(s.task_list,2)),1)])]),Y(V)==c?(l(),a("div",Ee,[(l(!0),a(D,null,M(s.task_list,(u,H)=>{var L,X;return l(),a("div",{class:"submission-item-container-content",key:H},[o("div",Ue,[o("div",{class:"submission-title",onClick:y=>se(u)},d(u.title),9,Ye),o("div",qe,[((L=u.file_id_list)==null?void 0:L.length)>0?(l(),a("div",ze,[(l(!0),a(D,null,M(u.file_name_list,(y,k)=>(l(),a("div",{class:"submission-file-item",key:k,onClick:le=>x(u.file_id_list[k])},d(y),9,Oe))),128))])):S("",!0),o("div",Re,d(Y(N)(u.date).format("HH:mm:ss")),1),Y(w)?(l(),a("select",{key:2,class:"submission-option",style:J({backgroundColor:v[u.status]})},[(l(),a(D,null,M(g,(y,k)=>o("option",{class:"submission-option-item",value:k,key:k,selected:u.status==k,onClick:le=>ie(u,k)},d(y),9,je)),64))],4)):(l(),F(K,{key:1,class:ce({"submission-status":!0,"submission-status-error":u.status==3}),style:J({backgroundColor:v[u.status]}),onClick:t[3]||(t[3]=y=>de(w)?w.value=!0:w=!0)},{default:B(()=>[G(d(g[u.status]),1)]),_:2},1032,["class","style"]))])]),o("div",Ae,d(u.message),1),H!=((X=s.task_list)==null?void 0:X.length)-1?(l(),a("hr",He)):S("",!0)])}),128))])):S("",!0)]))),128))])):(l(),a("div",Le," Nothing to show! "))]))}}),Qe=z(Xe,[["__scopeId","data-v-32aa57a2"]]);export{Qe as default};
