import{P as Q,h as y,a as H,F as R}from"./PTInput-DwDzYLEQ.js";import{d as V,o as i,b as N,w,S as q,e as a,_ as E,r as C,c as o,t as r,F as S,f as I,g as M,h as W,D as Z,i as x,j as $,k as v,l as ee,u as se,n as te,m as L,p as le,q as ie}from"./index-CBJSSvT5.js";const ae={class:"image-block"},ne=["src"],oe=V({__name:"ImageBlock",props:["image_url"],emits:["close"],setup(m,{emit:g}){const p=m,e=g;function b(){e("close")}return(h,_)=>(i(),N(q,null,{default:w(()=>[a("div",ae,[a("div",{class:"close",onClick:b},"X"),a("img",{src:p.image_url,alt:""},null,8,ne)])]),_:1}))}}),ce=E(oe,[["__scopeId","data-v-26ccb747"]]),de={class:"pt-upload"},ue={class:"pt-upload-button",for:"upload"},re=["accept"],me={key:0,class:"pt-upload-file-container"},_e={key:1,class:"pt-upload-file-message"},fe=V({__name:"PTUpload",props:{multiple:{type:Boolean,default:!1},accept:{type:String,default:""},text:{type:String,default:"Upload"},message:{type:String,default:"each file size must under 5MB"}},emits:["on-change"],setup(m,{emit:g}){const p=g,e=C([]);function b(h){for(let _ of h)if(_.size>5*1024*1024*8){alert("file size over 5MB");return}e.push(...h),p("on-change",e)}return(h,_)=>(i(),o("div",de,[a("label",ue,r(m.text),1),a("input",{class:"pt-upload-file",id:"upload",type:"file",multiple:"",accept:m.accept,onChange:_[0]||(_[0]=c=>b(c.target.files))},null,40,re),e.length>0?(i(),o("ul",me,[(i(!0),o(S,null,I(e,c=>(i(),o("li",{class:"pt-upload-file-item",key:c},r(c.name),1))),128))])):(i(),o("p",_e,r(m.message),1))]))}}),pe=E(fe,[["__scopeId","data-v-9a4f7612"]]),ge=m=>(le("data-v-20edf053"),m=m(),ie(),m),he={class:"submission"},be=ge(()=>a("h1",null,"This is the submission page",-1)),ke={key:2,class:"submission-content"},ve={class:"submission-collapse-container"},ye={class:"submission-collapse-func"},$e={class:"submission-collapse-func-item"},we={class:"submission-collapse-func-item"},Ce={class:"submission-collapse-func-item"},Se={class:"submission-func"},Ie=["onClick"],Be={class:"submission-func-container"},De={key:0,class:"submission-file"},Me=["onClick"],Ne={class:"submission-date"},Ve={class:"submission-message"},Ee={key:0,class:"submission-line"},Fe={key:3,class:"empty"},Te=V({__name:"Submission",setup(m){var T,U;const g=M(!1),p=M(!1),e=(T=W())==null?void 0:T.proxy;if(e==null||e==null)throw Error("Server, please try later");const b=["submit","checked","awarded","failed"],h=["#895ef9fc","#41d6ba","#3ddf58","#f95e85fc"],_=M(null),c=new Z,f=C([]),k=C([]),n=C({user_id:(U=c.user)==null?void 0:U.id,file_id_list:[],file_name_list:[],date:new Date,title:"",message:"",status:0});async function B(){e==null||e.$loading.show(),await c.findList("postgraduate-task","submission").then(l=>{k.splice(0,k.length),f.splice(0,f.length),l!=null&&k.push(...l),k.sort((t,s)=>s.date.getTime()-t.date.getTime()),k.forEach(t=>{f.length==0||f.filter(s=>s.id==y(t.date).format("YY-MM-DD")).length==0?f.push({id:y(t.date).format("YY-MM-DD"),task_list:[t]}):f.map(s=>{if(s.id==y(t.date).format("YY-MM-DD")){s.task_list.push(t);return}})})}).catch(l=>{e==null||e.$notification.show("Error",l),console.log(l)}).finally(()=>{e==null||e.$loading.hide()})}x(async()=>{await B()});function A(l){l.target.parentNode.nextElementSibling.style.display=="none"?l.target.parentNode.nextElementSibling.style.display="block":l.target.parentNode.nextElementSibling.style.display="none"}function D(l,t){let s=0;for(let d of l)d.status>=t&&s++;return s}function X(l){e==null||e.$loading.show(),_.value=null,c.getImageUrl("postgraduate-task","files",l).then(t=>{_.value=t,e==null||e.$loading.hide(),g.value=!0})}function G(){_.value=null,g.value=!1}function F(){p.value=!p.value,p.value==!1&&(n.message==null||n.title==null||n.message.trim().length==0||n.title.trim().length==0?alert("Nothing to submit! The form should be completed!"):(n.date=new Date,c.addOne("postgraduate-task","submission",n).then(()=>{e==null||e.$notification.show("Success","add submission successfully!"),B(),n.file_id_list=[],n.file_name_list=[],n.message="",n.title=""})))}async function J(l){if(confirm(`is ready to delete ${l.title}!`)){if(prompt("input your delete token")!="delete")return;e==null||e.$loading.show(),await c.findOne("postgraduate-task","submission",{_id:l._id}).then(d=>{d&&d.file_id_list&&d.file_id_list.length>0&&c.deleteMany("postgraduate-task","files",{_id:{$in:d.file_id_list}}),d&&c.deleteOne("postgraduate-task","submission",{_id:d._id}),B()}).finally(()=>{e==null||e.$loading.hide()})}else e==null||e.$notification.show("Cancel","operate already canceled!")}function K(l){e==null||e.$loading.show();for(let t of l)c.uploadFile("postgraduate-task","files",t).then(s=>{var d,u;(d=n.file_id_list)==null||d.push(s.insertedId),(u=n.file_name_list)==null||u.push(s.file_name)}).catch(s=>{console.log(s),e==null||e.$notification("Error","upload file error, please try again later")}).finally(()=>{e==null||e.$loading.hide()})}return(l,t)=>(i(),o("div",he,[g.value?(i(),N(ce,{key:0,image_url:_.value,onClose:G},null,8,["image_url"])):$("",!0),be,v(Q,{class:"submit-button",type:"primary",onClick:F},{default:w(()=>[ee("submit")]),_:1}),p.value?(i(),N(q,{key:1},{default:w(()=>[v(R,{onClose:t[2]||(t[2]=()=>p.value=!1),onSubmit:F},{form:w(()=>[v(H,{placeholder:"title",modelValue:n.title,"onUpdate:modelValue":t[0]||(t[0]=s=>n.title=s)},null,8,["modelValue"]),v(pe,{onOnChange:K,accept:".png, .jpg, .jpeg"}),v(H,{placeholder:"message",modelValue:n.message,"onUpdate:modelValue":t[1]||(t[1]=s=>n.message=s)},null,8,["modelValue"])]),_:1})]),_:1})):$("",!0),(f==null?void 0:f.length)>0?(i(),o("ul",ke,[(i(!0),o(S,null,I(f,(s,d)=>(i(),o("li",{class:"submission-item",key:s.id},[a("div",ve,[a("div",{class:"submission-collapse",onClick:A},r(s.id),1),a("div",ye,[a("span",$e,"Submitted: "+r(D(s.task_list,0)),1),a("span",we,"Checked: "+r(D(s.task_list,1)),1),a("span",Ce,"Awarded: "+r(D(s.task_list,2)),1)])]),a("div",{class:"submission-item-container",style:L({display:d==0?"display":"none"})},[(i(!0),o(S,null,I(s.task_list,(u,Y)=>{var z,P;return i(),o("div",{class:"submission-item-container-content",key:Y},[a("div",Se,[a("div",{class:"submission-title",onClick:O=>J(u)},r(u.title),9,Ie),a("div",Be,[((z=u.file_id_list)==null?void 0:z.length)>0?(i(),o("div",De,[(i(!0),o(S,null,I(u.file_name_list,(O,j)=>(i(),o("div",{class:"submission-file-item",key:j,onClick:Ue=>X(u.file_id_list[j])},r(O),9,Me))),128))])):$("",!0),a("div",Ne,r(se(y)(u.date).format("HH:mm:ss")),1),a("div",{class:te({"submission-status":!0,"submission-status-error":u.status==3}),style:L({backgroundColor:h[u.status]})},r(b[u.status]),7)])]),a("div",Ve,r(u.message),1),Y!=((P=s.task_list)==null?void 0:P.length)-1?(i(),o("hr",Ee)):$("",!0)])}),128))],4)]))),128))])):(i(),o("div",Fe," Nothing to show! "))]))}}),Pe=E(Te,[["__scopeId","data-v-20edf053"]]);export{Pe as default};
